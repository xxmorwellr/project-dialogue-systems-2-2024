{"version":3,"file":"SpeechSynthesisUtterance.js","names":["asyncDecodeAudioData","audioContext","arrayBuffer","Promise","resolve","reject","promise","decodeAudioData","then","playDecoded","audioBuffer","source","audioContextClosed","EventAsPromise","sourceEnded","unsubscribe","subscribeEvent","state","target","eventListener","buffer","onended","connect","destination","start","race","upcoming","text","_lang","_pitch","_rate","_voice","_volume","onboundary","onend","onerror","onmark","onpause","onresume","onstart","value","arrayBufferPromise","fetchSpeechData","authorizationToken","lang","window","navigator","language","outputFormat","pitch","rate","voice","voiceURI","volume","createBufferSource","emit","_playingSource","error","type","stop","DOMEventEmitter"],"sources":["../../../src/BingSpeech/TextToSpeech/SpeechSynthesisUtterance.js"],"sourcesContent":["import DOMEventEmitter from '../Util/DOMEventEmitter';\nimport EventAsPromise from 'event-as-promise';\nimport fetchSpeechData from './fetchSpeechData';\nimport subscribeEvent from './subscribeEvent';\n\nfunction asyncDecodeAudioData(audioContext, arrayBuffer) {\n  return new Promise((resolve, reject) => {\n    const promise = audioContext.decodeAudioData(arrayBuffer, resolve, reject);\n\n    // Newer implementation of \"decodeAudioData\" will return a Promise\n    promise && typeof promise.then === 'function' && resolve(promise);\n  });\n}\n\nfunction playDecoded(audioContext, audioBuffer, source) {\n  return new Promise(async (resolve, reject) => {\n    const audioContextClosed = new EventAsPromise();\n    const sourceEnded = new EventAsPromise();\n    const unsubscribe = subscribeEvent(audioContext, 'statechange', ({ target: { state } }) => state === 'closed' && audioContextClosed.eventListener());\n\n    try {\n      source.buffer = audioBuffer;\n      // \"ended\" may not fire if the underlying AudioContext is closed prematurely\n      source.onended = sourceEnded.eventListener;\n\n      source.connect(audioContext.destination);\n      source.start(0);\n\n      await Promise.race([\n        audioContextClosed.upcoming(),\n        sourceEnded.upcoming()\n      ]);\n\n      resolve();\n    } catch (err) {\n      reject(err);\n    } finally {\n      unsubscribe();\n    }\n  });\n}\n\nexport default class extends DOMEventEmitter {\n  constructor(text) {\n    super(['boundary', 'end', 'error', 'mark', 'pause', 'resume', 'start']);\n\n    this._lang = null;\n    this._pitch = 1;\n    this._rate = 1;\n    this._voice = null;\n    this._volume = 1;\n\n    this.text = text;\n\n    this.onboundary = null;\n    this.onend = null;\n    this.onerror = null;\n    this.onmark = null;\n    this.onpause = null;\n    this.onresume = null;\n    this.onstart = null;\n  }\n\n  get lang() { return this._lang; }\n  set lang(value) { this._lang = value; }\n\n  get pitch() { return this._pitch; }\n  set pitch(value) { this._pitch = value; }\n\n  get rate() { return this._rate; }\n  set rate(value) { this._rate = value; }\n\n  get voice() { return this._voice; }\n  set voice(value) { this._voice = value; }\n\n  get volume() { return this._volume; }\n  set volume(value) { this._volume = value; }\n\n  async preload() {\n    this.arrayBufferPromise = fetchSpeechData({\n      authorizationToken: this.authorizationToken,\n      lang: this.lang || window.navigator.language,\n      outputFormat: this.outputFormat,\n      pitch: this.pitch,\n      rate: this.rate,\n      text: this.text,\n      voice: this.voice && this.voice.voiceURI,\n      volume: this.volume\n    });\n\n    await this.arrayBufferPromise;\n  }\n\n  async play(audioContext) {\n    try {\n      // HACK: iOS requires bufferSourceNode to be constructed before decoding data\n      const source = audioContext.createBufferSource();\n      const audioBuffer = await asyncDecodeAudioData(audioContext, await this.arrayBufferPromise);\n\n      this.emit('start');\n      this._playingSource = source;\n\n      await playDecoded(audioContext, audioBuffer, source);\n\n      this._playingSource = null;\n      this.emit('end');\n    } catch (error) {\n      this.emit('error', { error, type: 'error' });\n    }\n  }\n\n  stop() {\n    this._playingSource && this._playingSource.stop();\n  }\n}\n"],"mappings":"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"}