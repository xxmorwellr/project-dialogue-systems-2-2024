{"version":3,"file":"createSpeechSynthesisPonyfill.js","names":["DEFAULT_OUTPUT_FORMAT","TOKEN_EXPIRATION","TOKEN_EARLY_RENEWAL","authorizationToken","ponyfill","AudioContext","window","webkitAudioContext","subscriptionKey","console","warn","fetchMemoizedAuthorizationToken","memoize","fetchAuthorizationToken","arg","prevArg","now","SpeechSynthesis","outputFormat","queue","AudioContextQueue","stop","fetchVoices","pause","resume","utterance","SpeechSynthesisUtterance","Error","Promise","resolve","reject","addEventListener","Date","preload","push","speaking","DOMEventEmitter","speechSynthesis"],"sources":["../../../src/BingSpeech/TextToSpeech/createSpeechSynthesisPonyfill.js"],"sourcesContent":["import memoize from 'memoize-one';\n\nimport AudioContextQueue from './AudioContextQueue';\nimport DOMEventEmitter from '../Util/DOMEventEmitter';\nimport fetchAuthorizationToken from '../fetchAuthorizationToken';\nimport fetchVoices from './fetchVoices';\nimport SpeechSynthesisUtterance from './SpeechSynthesisUtterance';\n\n// Supported output format can be found at https://docs.microsoft.com/en-us/azure/cognitive-services/Speech/API-Reference-REST/BingVoiceOutput#Subscription\nconst DEFAULT_OUTPUT_FORMAT = 'audio-16khz-128kbitrate-mono-mp3';\n\nconst TOKEN_EXPIRATION = 600000;\nconst TOKEN_EARLY_RENEWAL = 60000;\n\nexport default ({\n  authorizationToken,\n  ponyfill = {\n    AudioContext: window.AudioContext || window.webkitAudioContext\n  },\n  subscriptionKey\n}) => {\n  if (!authorizationToken && !subscriptionKey) {\n    console.warn('Either authorizationToken or subscriptionKey must be specified');\n\n    return {};\n  } else if (!ponyfill.AudioContext) {\n    console.warn('This browser does not support Web Audio and it will not work with Cognitive Services Speech Services.');\n\n    return {};\n  }\n\n  const fetchMemoizedAuthorizationToken = memoize(\n    ({ subscriptionKey }) => fetchAuthorizationToken(subscriptionKey),\n    (arg, prevArg) => (\n      arg.subscriptionKey === prevArg.subscriptionKey\n      && arg.now - prevArg.now < TOKEN_EXPIRATION - TOKEN_EARLY_RENEWAL\n    )\n  );\n\n  class SpeechSynthesis extends DOMEventEmitter {\n    constructor() {\n      super(['voiceschanged']);\n\n      this.outputFormat = DEFAULT_OUTPUT_FORMAT;\n      this.queue = new AudioContextQueue(ponyfill);\n    }\n\n    cancel() {\n      this.queue.stop();\n    }\n\n    getVoices() {\n      return fetchVoices();\n    }\n\n    pause() {\n      this.queue.pause();\n    }\n\n    resume() {\n      this.queue.resume();\n    }\n\n    async speak(utterance) {\n      if (!(utterance instanceof SpeechSynthesisUtterance)) {\n        throw new Error('invalid utterance');\n      }\n\n      return new Promise(async (resolve, reject) => {\n        utterance.addEventListener('end', resolve);\n        utterance.addEventListener('error', reject);\n\n        utterance.authorizationToken =\n          typeof authorizationToken === 'function' ?\n            await authorizationToken()\n          : authorizationToken ?\n            await authorizationToken\n          : await fetchMemoizedAuthorizationToken({\n            now: Date.now,\n            subscriptionKey\n          });\n        utterance.outputFormat = this.outputFormat;\n        utterance.preload();\n\n        this.queue.push(utterance);\n      });\n    }\n\n    get speaking() {\n      return this.queue.speaking;\n    }\n  }\n\n  return {\n    speechSynthesis: new SpeechSynthesis(),\n    SpeechSynthesisUtterance\n  };\n}\n"],"mappings":"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"}